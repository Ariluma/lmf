<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>LMF – Particle Flow (White, 50k Blue)</title>
<style>
  html,body{
    margin:0;
    padding:0;
    height:100%;
    overflow:hidden;
    background:#ffffff;
  }
  body{
    touch-action:none;
    -webkit-user-select:none;
    user-select:none;
    font-family:-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",sans-serif;
  }
  canvas{
    display:block;
    width:100vw;
    height:100vh;
    background:#ffffff;
  }
  .hud{
    position:fixed;
    left:12px;
    top:10px;
    font-size:12px;
    padding:5px 9px;
    border-radius:10px;
    background:rgba(255,255,255,0.9);
    border:1px solid rgba(0,0,0,0.06);
    color:#111827;
    box-shadow:0 6px 18px rgba(0,0,0,0.12);
  }
</style>
</head>
<body>
<canvas id="flow"></canvas>
<div class="hud">
  LMF Particle Flow · 50.000 Punkte<br>
  Tippen: Punkt setzen (max. 3) · Halten: Stärke ↑
</div>

<script>
(function(){

  const canvas = document.getElementById("flow");
  const ctx = canvas.getContext("2d");

  let W = window.innerWidth;
  let H = window.innerHeight;

  function resize(){
    W = window.innerWidth;
    H = window.innerHeight;
    canvas.width = W;
    canvas.height = H;
  }
  resize();
  window.addEventListener("resize", resize);

  const BLUE = "#1437ff";
  const PARTICLES = 50000;

  const particles = [];
  function resetParticle(p){
    p.x = Math.random()*W;
    p.y = Math.random()*H;
    p.vx = 0;
    p.vy = 0;
    p.life = 0;
    p.maxLife = 4 + Math.random()*3;
  }

  for(let i=0;i<PARTICLES;i++){
    const p = {x:0,y:0,vx:0,vy:0,life:0,maxLife:0};
    resetParticle(p);
    particles.push(p);
  }

  // Fixierte Attractor-Punkte
  const attractors = []; // {x,y,strength}
  let activeAttractor = null; // aktuell gedrückter Punkt

  function addAttractor(x,y){
    const a = {x:x,y:y,strength:0.4}; // Einstieg mit leichter Stärke
    if(attractors.length >= 3){
      // ältesten löschen
      attractors.shift();
    }
    attractors.push(a);
    activeAttractor = a;
  }

  function getPos(e){
    const r = canvas.getBoundingClientRect();
    if(e.touches && e.touches[0]){
      return {
        x: e.touches[0].clientX - r.left,
        y: e.touches[0].clientY - r.top
      };
    }
    return {
      x: e.clientX - r.left,
      y: e.clientY - r.top
    };
  }

  // Touch / Maus: neuen Punkt setzen + ggf. halten
  function pointerDown(e){
    const p = getPos(e);
    addAttractor(p.x,p.y);
  }

  function pointerMove(e){
    if(!activeAttractor) return;
    const p = getPos(e);
    // Optional: aktiven Punkt mit Finger mitbewegen
    activeAttractor.x = p.x;
    activeAttractor.y = p.y;
  }

  function pointerUp(){
    activeAttractor = null;
  }

  canvas.addEventListener("touchstart", e=>{
    e.preventDefault();
    pointerDown(e);
  },{passive:false});

  canvas.addEventListener("touchmove", e=>{
    e.preventDefault();
    pointerMove(e);
  },{passive:false});

  canvas.addEventListener("touchend", e=>{
    e.preventDefault();
    pointerUp();
  });

  canvas.addEventListener("mousedown", e=>{
    pointerDown(e);
  });

  canvas.addEventListener("mousemove", e=>{
    if(e.buttons & 1){
      pointerMove(e);
    }
  });

  window.addEventListener("mouseup", pointerUp);

  let last = performance.now();

  function loop(now){
    const dt = Math.min(0.05,(now-last)/1000);
    last = now;

    // aktive Berührung: Stärke langsam erhöhen bis max
    if(activeAttractor){
      activeAttractor.strength = Math.min(1.8, activeAttractor.strength + dt*0.6);
    }

    // Weißer Hintergrund mit leichtem Fade, um Trails zu behalten
    ctx.fillStyle = "rgba(255,255,255,0.2)";
    ctx.fillRect(0,0,W,H);

    ctx.fillStyle = BLUE;
    ctx.beginPath();

    const damping = 0.86;
    const baseForce = 160;

    for(let i=0;i<PARTICLES;i++){
      const p = particles[i];

      let ax = 0, ay = 0;
      for(let j=0;j<attractors.length;j++){
        const a = attractors[j];
        const dx = a.x - p.x;
        const dy = a.y - p.y;
        const d2 = dx*dx + dy*dy + 40; // +40: Vermeide extreme Kräfte
        const inv = 1 / Math.sqrt(d2);
        const force = baseForce * (a.strength || 0.4) * inv * inv; // ~1/r^2
        ax += dx * inv * force;
        ay += dy * inv * force;
      }

      p.vx += ax * dt;
      p.vy += ay * dt;

      p.vx *= damping;
      p.vy *= damping;

      p.x += p.vx * dt;
      p.y += p.vy * dt;
      p.life += dt;

      if(p.x < -20 || p.x > W+20 || p.y < -20 || p.y > H+20 || p.life > p.maxLife){
        resetParticle(p);
        continue;
      }

      ctx.rect(p.x, p.y, 1.0, 1.0);
    }

    ctx.fill();
    requestAnimationFrame(loop);
  }

  requestAnimationFrame(loop);

})();
</script>
</body>
</html>
